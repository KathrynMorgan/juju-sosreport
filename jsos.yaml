#####################################################################
#        _._   
#       /_ _`.      (c) 2016-2018, David A. Desrosiers
#       (.(.)|      david dot desrosiers at canonical dot com
#       |\_/'|   
#       )____`\     If you find this useful, please drop me     
#      //_V _\ \    an email, or send me bug reports if you find
#     ((  |  `(_)   problems with it.
#    / \> '   / \
#    \  \.__./  /   Ansible playbook for pulling sosreports from
#     `-'    `-'    a juju-deployed cluster of units
#
#####################################################################
# Make sure you pass in the correct '-l <host_group>' param to limit
# collection of the sosreports for those nodes, else it will do ALL
# nodes in the model

###### First task, runs on the targeted units themselves ######
- name: Generate, collect and upload sosreports from each unit in the juju controller scope
  hosts: all
  # Change this user to one that has ssh access into the units
  remote_user: '{{ remote_user }}'
  become: yes
  vars_files:
    - vars.yaml

  tasks:
    - name: Create a directory matching the case_id for the sosreports to land in
      file: path={{ temp_dir}} state=directory

    - name: Create sosreports from each juju unit
      shell: '{{ sos_cmd }} {{ sos_opt }} --tmp-dir={{ temp_dir }} --name={{ juju_unit }} --case-id={{ case_id }}'

    - name: Build a list of the sosreport filenames to fetch
      find:
        paths: '{{ temp_dir }}'
        file_type: file
        recurse: no
        patterns: 'sosreport*{{ case_id }}-{{ date_frag }}*xz,sosreport*{{ case_id }}-{{ date_frag }}*md5'
      register: sosreport_files

    # We need to do this because the reports are owned by 'root:root' on
    # the units and we can't pull them back (no root ssh) without +r perms
    - name: Set permissions of remote sosreport files so we can read them
      file:
        path: '{{ item.path }}'  
        owner: '{{ remote_user }}'
        group: ubuntu
        mode: 0644
      become: yes
      with_items: '{{ sosreport_files.files }}'

    - name: Fetch the sosreports from the hosts
      fetch:
        src: '{{ item.path }}'
        dest: '{{ temp_dir }}/{{ item.path | basename }}'
        flat: yes
      with_items: '{{ sosreport_files.files }}'

    - name: Clean out sosreports from the remote units after fetching
      file:
        path: '{{ temp_dir }}'
        state: absent

###### Second task, runs exclusively on the controller ######
- name: Upload sosreports to remote support portal
  hosts: all
  connection: local
  become: no
  vars_files:
    - vars.yaml

  tasks:
    - name: Adding SSH key to your controller to permit uploads
      delegate_to: localhost
      authorized_key:
        user: "{{ lookup('env','USER') }}"
        state: present
        key: "{{ lookup('file', 'support.key') }}"

    - name: Create the remote directory for the case in the portal
      delegate_to: localhost
      command: bash -c "sshpass -p {{ sftp_user }} sftp -C {{ sftp_user }}@{{ sftp_host }} <<< $'mkdir {{ case_id }}'"

    - name: Upload files to the support portal SFTP site
      delegate_to: localhost
      command: bash -c "sshpass -p {{ sftp_user }} sftp -C {{ sftp_user }}@{{ sftp_host }} <<< $'put {{ item.path }} {{ case_id }}'"
      with_items: '{{ sosreport_files.files }}'

    - name: Removing SSH key from your controller (will be added again at next invocation)
      delegate_to: localhost
      authorized_key:
        user: "{{ lookup('env','USER') }}"
        state: absent
        key: "{{ lookup('file', 'support.key') }}"
